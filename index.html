<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="qie.png" type="image/png">
    <title>Happy Valentine <3</title>
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    <style>
        body {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #fff0f3;
            background-image: 
                linear-gradient(rgba(255, 208, 215, 0.5) 50px, transparent 2px),
                linear-gradient(90deg, rgba(255, 208, 215, 0.5) 50px, transparent 2px);
            background-size: 100px 100px;
            font-family: 'ZCOOL KuaiLe', cursive;
        }

        /* éŸ³ä¹æŒ‰é’®æ ·å¼ */
        #musicBtn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(255, 179, 193, 0.4);
            z-index: 1000;
            border: 2px solid #ffccd5;
            overflow: hidden;
        }

        #musicGif {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.6;
            transition: opacity 0.3s;
        }

        @keyframes rotating {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .music-on { animation: rotating 3s linear infinite; border-color: #ff758f !important; }
        .music-on img { opacity: 1 !important; }

        /* é¢æ¿/çº¸å¼ æ ·å¼ */
        .panel {
            background: white;
            background-image: linear-gradient(#f0f0f0 1px, transparent 1px);
            background-size: 100% 30px;
            background-attachment: local;
            padding: 40px 30px;
            border-radius: 15px;
            box-shadow: 2px 5px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
            position: relative;
            width: 360px;
            height: 520px;
            border: 1px solid #e0e0e0;
            overflow: visible; 
        }

        .panel::before {
            content: "";
            position: absolute;
            top: -18px;
            left: 50%;
            transform: translateX(-50%) rotate(-1deg);
            width: 120px;
            height: 35px;
            background: rgba(255, 182, 193, 0.7);
            border-radius: 2px;
            z-index: 10;
        }

        h1 { 
            color: #4a4a4a; 
            font-size: 1.6rem; 
            min-height: 60px; 
            line-height: 1.6;
            display: inline-block;
            padding: 0 10px;
        }

        .gif-container { height: 180px; display: flex; justify-content: center; align-items: center; margin-bottom: 10px; }
        .gif-container img { width: 160px; }

        .buttons-area { position: relative; width: 100%; height: 230px; margin-top: 10px; }

        button {
            padding: 10px 25px;
            font-size: 1.2rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 0px rgba(0,0,0,0.1);
        }

        #yesBtn { background-color: #ff758f; color: white; position: absolute; left: 50%; top: 25%; transform: translate(-50%, -50%); z-index: 100; }
        #yesBtn:active { transform: translate(-50%, -48%); box-shadow: none; }

        #noBtn { 
            background-color: #f8f9fa; 
            color: #adb5bd; 
            position: absolute; 
            left: 50%; 
            top: 65%; 
            transform: translate(-50%, -50%); 
            z-index: 50; 
            border: 1px solid #dee2e6;
            animation: pulse 1.5s ease-in-out infinite, glow 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

        @keyframes glow {
            0%, 100% { 
                box-shadow: 0 0 5px rgba(255, 117, 143, 0.5),
                            0 0 10px rgba(255, 117, 143, 0.3),
                            0 0 15px rgba(255, 117, 143, 0.2);
            }
            50% { 
                box-shadow: 0 0 10px rgba(255, 142, 163, 0.8),
                            0 0 20px rgba(255, 117, 143, 0.6),
                            0 0 30px rgba(255, 117, 143, 0.4),
                            0 0 40px rgba(255, 117, 143, 0.2);
            }
        }

        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        @keyframes colorChange { 0% { color: #ff758f; } 50% { color: #ffacba; } 100% { color: #ff758f; } }

        #question { animation: bounce 2s ease-in-out infinite; }
        .letter { display: inline-block; animation: wave 0.6s infinite alternate; }
        @keyframes wave { from { transform: translateY(0); } to { transform: translateY(-5px); } }
        .rainbow-text { animation: colorChange 1s infinite; }
    </style>
</head>
<body>
    <audio id="bgm" loop src="bgm.mp3" preload="auto"></audio>
    <audio id="noEffect" src="no.mp3" preload="auto"></audio>
    <audio id="yesMusic" loop src="bgm2.mp3" preload="auto"></audio>

    <div id="musicBtn" onclick="toggleMusic()">
        <img id="musicGif" src="happy.gif">
    </div>

    <div class="panel" id="mainPanel">
        <div class="gif-container">
            <img id="displayGif" src="hello.png">
        </div>

        <h1 id="question">äº²çˆ±çš„å°ç« åŒå­¦<br>ä½ è¦ä¸è¦åšæˆ‘çš„Valentineï¼Ÿ</h1>

        <div class="buttons-area" id="area">
            <button id="yesBtn" onclick="celebrate()">å¥½å‘€ï¼</button>
            <button id="noBtn" onmouseover="handleNoHover()" onclick="handleNoClick()">ä¸è¦</button>
        </div>
    </div>

    <script>
        // è·å–éŸ³é¢‘å’ŒæŒ‰é’®å¯¹è±¡
        const bgm = document.getElementById('bgm');
        const noEffect = document.getElementById('noEffect');
        const yesMusic = document.getElementById('yesMusic');
        const musicBtn = document.getElementById('musicBtn');
        yesMusic.volume = 0.2;
        noEffect.volume = 1;
        bgm.volume = 0.2;
        let yesScale = 1;
        let noScale = 1;
        let attempts = 0;
        let hasClickedNo = false; // æ ‡è®°æ˜¯å¦å·²ç»ç‚¹å‡»è¿‡"ä¸è¦"æŒ‰é’®

        // ç¡®ä¿éŸ³é¢‘å…ƒç´ æ­£ç¡®åˆå§‹åŒ–
        bgm.addEventListener('canplaythrough', () => {
            console.log('BGM å·²åŠ è½½å®Œæˆ');
        });
        noEffect.addEventListener('canplaythrough', () => {
            console.log('noéŸ³æ•ˆ å·²åŠ è½½å®Œæˆ');
        });
        noEffect.addEventListener('error', (e) => {
            console.error('noéŸ³æ•ˆåŠ è½½é”™è¯¯:', e, noEffect.error);
        });
        bgm.addEventListener('error', (e) => {
            console.error('BGMåŠ è½½é”™è¯¯:', e, bgm.error);
        });

        // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥éŸ³é¢‘çŠ¶æ€
        window.addEventListener('load', () => {
            console.log('é¡µé¢åŠ è½½å®Œæˆ');
            console.log('noEffect çŠ¶æ€:', {
                readyState: noEffect.readyState,
                networkState: noEffect.networkState,
                error: noEffect.error,
                src: noEffect.src
            });
            console.log('bgm çŠ¶æ€:', {
                readyState: bgm.readyState,
                networkState: bgm.networkState,
                error: bgm.error,
                src: bgm.src
            });
        });

        // æ–‡å­—æ³¢æµªåŒ–å‡½æ•°
        function wrapText(text) {
            return text.split('').map((char, i) => 
                `<span class="letter" style="animation-delay: ${i * 0.1}s">${char}</span>`
            ).join('');
        }

        // ç»Ÿä¸€æ§åˆ¶éŸ³ä¹å›¾æ ‡æ—‹è½¬
        function updateMusicIcon(isPlaying) {
            if (isPlaying) {
                musicBtn.classList.add('music-on');
            } else {
                musicBtn.classList.remove('music-on');
            }
        }

        // éŸ³ä¹æ‰‹åŠ¨å¼€å…³
        function toggleMusic() {
            const currentActive = attempts === -1 ? yesMusic : bgm; 
            if (currentActive.paused) {
                currentActive.play();
                updateMusicIcon(true);
            } else {
                currentActive.pause();
                updateMusicIcon(false);
            }
        }

        // æ’­æ”¾éŸ³é¢‘çš„é€šç”¨å‡½æ•°
        function playAudio() {
            // ç¬¬ä¸€æ¬¡äº¤äº’æ—¶å°è¯•æ’­æ”¾ BGM
            if (bgm.paused && attempts >= 0) {
                const bgmPromise = bgm.play();
                if (bgmPromise !== undefined) {
                    bgmPromise.then(() => {
                        console.log("BGM æ’­æ”¾æˆåŠŸ");
                        updateMusicIcon(true);
                    }).catch(e => {
                        console.error("BGMæ’­æ”¾å¤±è´¥:", e);
                    });
                } else {
                    updateMusicIcon(true);
                }
            }

            // æ’­æ”¾æ‹’ç»éŸ³æ•ˆ
            noEffect.pause();
            noEffect.currentTime = 0;
            
            noEffect.play().then(() => {
                console.log("noéŸ³æ•ˆ æ’­æ”¾æˆåŠŸ");
            }).catch(e => {
                console.error("noéŸ³æ•ˆæ’­æ”¾å¤±è´¥:", e);
                if (noEffect.readyState < 2) {
                    noEffect.load();
                    noEffect.addEventListener('canplay', () => {
                        noEffect.play().catch(e2 => {
                            console.error("åŠ è½½åæ’­æ”¾ä»ç„¶å¤±è´¥:", e2);
                        });
                    }, { once: true });
                }
            });
        }

        // å¤„ç†hoveräº‹ä»¶ï¼šç¬¬ä¸€æ¬¡hoveråªæ’­æ”¾éŸ³é¢‘ï¼Œä¸ç§»åŠ¨ï¼›ä¹‹åhoveræ‰ä¼šç§»åŠ¨
        function handleNoHover() {
            // æ’­æ”¾éŸ³é¢‘
            playAudio();
            
            // åªæœ‰åœ¨ç‚¹å‡»è¿‡"ä¸è¦"æŒ‰é’®åï¼Œhoveræ‰ä¼šè®©æŒ‰é’®è·‘èµ°
            if (hasClickedNo) {
                moveAndShrink();
            }
        }

        // å¤„ç†clickäº‹ä»¶ï¼šç¬¬ä¸€æ¬¡ç‚¹å‡»æ—¶æ’­æ”¾éŸ³é¢‘å¹¶ç§»åŠ¨ï¼ŒåŒæ—¶å¯ç”¨hoverå°±è·‘çš„æ¨¡å¼
        function handleNoClick() {
            // æ’­æ”¾éŸ³é¢‘ï¼ˆclickæ˜¯æ˜ç¡®çš„ç”¨æˆ·äº¤äº’ï¼Œä¸€å®šèƒ½æ’­æ”¾ï¼‰
            playAudio();
            
            // ç¬¬ä¸€æ¬¡ç‚¹å‡»æ—¶ï¼Œæ ‡è®°å·²ç‚¹å‡»ï¼Œå¹¶ç§»é™¤åˆå§‹åŠ¨ç”»å’Œå®šä½
            if (!hasClickedNo) {
                hasClickedNo = true;
                const noBtn = document.getElementById('noBtn');
                noBtn.style.animation = 'none'; // ç§»é™¤åˆå§‹åŠ¨ç”»
                noBtn.style.transform = 'scale(1)'; // ç§»é™¤åˆå§‹çš„translateå®šä½
            }
            
            // æ‰§è¡Œç§»åŠ¨å’Œç¼©æ”¾
            moveAndShrink();
        }

        // ç§»åŠ¨å’Œç¼©æ”¾æŒ‰é’®
        function moveAndShrink() {
            const noBtn = document.getElementById('noBtn');
            const yesBtn = document.getElementById('yesBtn');
            const area = document.getElementById('area');
            const question = document.getElementById('question');

            // è·å–yesBtnçš„å®é™…ä½ç½®å’Œå¤§å°ï¼ˆè€ƒè™‘transformï¼‰
            const areaRect = area.getBoundingClientRect();
            const yesBtnRect = yesBtn.getBoundingClientRect();
            
            // è®¡ç®—yesBtnåœ¨areaå†…çš„ç›¸å¯¹ä½ç½®
            const yesBtnLeft = yesBtnRect.left - areaRect.left;
            const yesBtnTop = yesBtnRect.top - areaRect.top;
            const yesBtnRight = yesBtnLeft + yesBtnRect.width;
            const yesBtnBottom = yesBtnTop + yesBtnRect.height;
            
            // æ·»åŠ ä¸€äº›è¾¹è·ï¼Œç¡®ä¿ä¸ä¼šå¤ªé è¿‘
            const margin = 10;
            const yesBtnSafeLeft = yesBtnLeft - margin;
            const yesBtnSafeTop = yesBtnTop - margin;
            const yesBtnSafeRight = yesBtnRight + margin;
            const yesBtnSafeBottom = yesBtnBottom + margin;

            // éšæœºä½ç§»ï¼Œé¿å…ä¸yesBtné‡å 
            const maxX = area.clientWidth - noBtn.offsetWidth;
            const maxY = area.clientHeight - noBtn.offsetHeight;
            
            let randomX, randomY;
            let findAttempts = 0;
            const maxFindAttempts = 50; // æœ€å¤šå°è¯•50æ¬¡æ‰¾åˆ°ä¸é‡å çš„ä½ç½®
            
            do {
                randomX = Math.max(0, Math.min(Math.random() * maxX, maxX));
                randomY = Math.max(0, Math.min(Math.random() * maxY, maxY));
                findAttempts++;
                
                // æ£€æŸ¥æ˜¯å¦ä¸yesBtné‡å 
                const noBtnRight = randomX + noBtn.offsetWidth;
                const noBtnBottom = randomY + noBtn.offsetHeight;
                
                const overlaps = !(
                    noBtnRight < yesBtnSafeLeft || 
                    randomX > yesBtnSafeRight || 
                    noBtnBottom < yesBtnSafeTop || 
                    randomY > yesBtnSafeBottom
                );
                
                if (!overlaps || findAttempts >= maxFindAttempts) {
                    break;
                }
            } while (true);

            noBtn.style.left = randomX + 'px';
            noBtn.style.top = randomY + 'px';

            // æŒ‰é’®ç¼©æ”¾
            attempts++;
            yesScale += 0.4;
            if (noScale > 0.5) noScale -= 0.1;

            yesBtn.style.transform = `translate(-50%, -50%) scale(${yesScale})`;
            noBtn.style.transform = `scale(${noScale})`;

            // åŠ¨æ€æ–‡æ¡ˆ
            const texts = ["ç‚¹é”™äº†å˜›ï¼Ÿ", "æˆ‘ä¼šéš¾è¿‡å“’", "ä¸è®¸æ‹’ç»ï¼", "å¿«ç‚¹å¥½å‘€ï¼", "å“¼ï¼"];
            if (attempts <= texts.length) {
                const rawText = texts[attempts - 1];
                question.innerHTML = wrapText(rawText); 
            }
        }

        // æ ¸å¿ƒé€»è¾‘ï¼šç­”åº”ã€éŸ³ä¹åˆ‡æ¢ã€é‡ç»˜é¡µé¢
        function celebrate() {
            // 1. åˆ‡æ¢éŸ³ä¹
            bgm.pause();
            yesMusic.play().catch(e => console.log("éŸ³ä¹æ’­æ”¾å—é˜»"));
            updateMusicIcon(true);
            
            // 2. æ ‡è®°æˆåŠŸçŠ¶æ€
            attempts = -1; 

            // 3. é¡µé¢é‡ç»˜å†…å®¹
            const panel = document.getElementById('mainPanel');
            panel.innerHTML = `
                <div style="padding-top: 40px; border-radius: 15px;">
                    <h1 style="font-size: 2rem; color: #ff758f; animation: bounce 0.5s infinite; padding: 0 10px;">æˆ‘å°±çŸ¥é“ä½ ä¼šç­”åº”å“’ï¼âœ¨</h1>
                    <div style="margin-top:20px;">
                        <img src="jump.gif" style="width:180px;">
                    </div>
                    <p class="rainbow-text" style="margin-top:25px; font-size:1.8rem; font-weight:bold;">ğŸ’– æƒ…äººèŠ‚å¿«ä¹ï¼ğŸ’–</p>
                </div>
            `;
        }
    </script>
</body>
</html>